<!DOCTYPE html>
<!-- 我的银行卡  -->
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, initial-scale=1.0, width=device-width" />
	<meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
	<title>我的银行卡</title>
	<link rel="stylesheet" type="text/css" href="../../css/wode/yinhangka.css">
</head>

<body class="yinhangka">

	<header class="header">
    <img src="../../image/common/back.png" class="back" onclick="javascript: kill();">
		<p class="header-title">我的银行卡</p>
</header>
<div class="content">
		<ul class="list">
				<li>
						<img src="../../image/wode/bank.png">
						<div class="card-message">
								<p class="bank-type">中国银行</p>
								<span class="card-type">储蓄卡</span>
										<p class="card-num">
										 <span class="hidenum">****</span> <span class="hidenum">****</span> <span class="hidenum">****</span>
										 <span class="shownum">5198</span> </p>
						</div>
				</li>
		</ul>
    <button class="btn" onclick="javascript:create('addcard')">绑定银行卡</button>
</div>


  <script type="text/javascript" charset="utf-8" src="../../script/global/api.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/component/router.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/component/base.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/global/urls.js"></script>
	<script type="text/javascript">
    var User = $api.getStorage('User');
		apiready = function () {
      setListener();
      init();
		}

    function init () {
      if (!checkNet() || !checkLogin()) return;
        sendRequest({
          url: 'GetBankCardList',
          values: {
            phone: User.Phone,
            deviceId: api.deviceId
          },
          showMessage: true,
          success: function (data) {
            User = $api.getStorage('User');
            User.Card = formatCard(data);
            $api.setStorage('User', User);
            setLayout(User.Card);
          }
        });
    }

    function setLayout (content) {
      if (content.length) {
        var htmlStr = '';
        for (var i = 0; i < content.length; i++) {
          htmlStr += setBankCardHTML(content[i]);
        }
        $api.addCls('title', 'background-write');
        $api.text('title-message', '绑定的银行卡将用于收款和还款');
        $api.html('swiper-wrapper', htmlStr);
        $api.removeCls('bank-wrap', 'aui-hide');
        $api.removeCls('note', 'aui-hide');
        setSwiper();
      }
      else {
        alertMsg('您尚未绑定银行卡！');
      }
    }

    function setBankCardHTML (card) {
      var htmlStr = '<li class="swiper-slide bank-item">' +
      '<div class="mantissa absolute font-size-35 text-write">' + card.number.substr(-4, 4) + '</div>' +
      '<div class="bg absolute">' +
      '<img class="bg-image" src="../../../image/lanqian/card/' + BankList[card.bank] + '.png">' +
      '</div>' +
      '</li>';
      return htmlStr;
    }

		function addCard () {
			if (checkNetwork() && checkLogin()) {
				if (User.Step[1]) {
          api.sendEvent({
    				name: 'OpenFrame',
    				extra: {
    					goal: 'tianjiayinhangka'
    				}
    			});
				}
        else {
					alertMsg('请先完成身份认证');
				}
			}
		}

		function setSwiper () {
			var swiper = new Swiper('#bank-wrap', {
				effect: 'coverflow',
				centeredSlides: true,
				slidesPerView: 'auto',
				coverflow: {
					rotate: 0,
					stretch: -50,
					depth: 200,
					modifier: 1.5,
					slideShadows: false
				}
			});
		}

    function setListener () {
      api.addEventListener(
        {name: 'Refresh'},
        function (ret, err) {
          if (ret) {
            alertMsg("绑定成功");
            init();
          }
        }
      );
      api.addEventListener(
        {name:'online'},
        function(ret, err){
          if (ret) init();
        }
      );
    }

    function formatCard (content) {
      var result = null;
      var cardList = [];
      var card = {};
      for (var i = 0; i < content.length; i++) {
        var oldCard = content[i];
        for (var key in oldCard) {
          switch (key) {
            case 'KaHao':
              card.number = oldCard.KaHao;
              break;
            case 'KaiHuHang':
              if (oldCard.KaiHuHang.indexOf('邮政') !== -1) {
                card.bank = '邮政储蓄银行';
              }
              else {
                card.bank = oldCard.KaiHuHang;
              }
              break;
            case 'BankType':
              card.type = oldCard.BankType;
              break;
          }
        }
        cardList.push(card);
        card = {};
      }
      return cardList;
    }
	</script>
</body>

</html>
