<!DOCTYPE html>
<!-- 近期待还 -->
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, initial-scale=1.0, width=device-width" />
  <meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
  <script type="text/javascript" charset="utf-8" src="../../script/flexible.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/api.js"></script>
  <title>近期待还</title>
  <link rel="stylesheet" type="text/css" href="../../css/aui.css">
  <link rel="stylesheet" type="text/css" href="../../css/aui-extends.css">
  <script type="text/javascript" charset="utf-8" src="../../iconfont/iconfont.js"></script>
  <!-- used _voucher.scss -->
</head>

<body class="jinqidaihuan">
  <section class="voucher background-write aui-hide" id="voucher">
    <div class="voucher-header font-size-24">
      <div class="voucher-title aui-pull-left text-gray">
        <svg class="icon icon-size-jiekuanjine" aria-hidden="true">
          <use xlink:href="#icon-jiekuanjine"></use>
        </svg>
        <span>待还金额(元)</span>
      </div>
      <div class="voucher-time aui-pull-right text-black">
        <span id="time"></span>
        <span>天后到期</span>
      </div>
    </div>
    <div class="voucher-content">
      <ul class="voucher-message aui-pull-left" id="voucher-message" onclick="javascript: jump('jietiaoxiangdan');">
        <li class="voucher-message-item aui-pull-left">
          <p class="message-number font-size-27 text-black">
            <span id="count"></span>
            <span>元</span>
          </p>
          <p class="message-tip font-size-24 text-gray">一次性还款</p>
        </li>
        <li class="voucher-message-item aui-pull-left">
          <p class="message-number font-size-27 text-black" id="date"></p>
          <p class="message-tip font-size-24 text-gray">还款日期</p>
        </li>
      </ul>
      <button class="voucher-btn aui-pull-right" onclick="javascript: gotoHome();">立即还款</button>
    </div>
  </section>
  <section class="cover" id="empty-wrap">
    <img class="image-note" src="../../image/empty-order.png">
    <p class="font-size-30 aui-text-center text-gray margin-top-30">你还没有待还订单哦~</p>
    <button class="loan-btn" onclick="javascript: gotoHome();">立即借款</button>
  </section>
  <script type="text/javascript" charset="utf-8" src="../../script/aui-pull-refresh.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/global-property.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/global-method.js"></script>
  <script type="text/javascript" charset="utf-8">
    var User = null;
    apiready = function () {
      setListener();
      init();
      pullRefresh();
    }

    function init () {
      if (checkNetwork() && checkLogin()) {
        User = $api.getStorage('User');
        sendRequest({
          url: 'GetCurrentRepaymentList',
          values: {
            deviceId: api.deviceId,
            phone: User.Phone
          },
          showMessage: true,
          success: function (data) {
            data = formatData(data);
            setLayout(data);
          },
          fail: function () {
            setLayout({
              status: false
            });
          }
        });
      }
    }

    function setLayout (content) {
      if (content.status) {
        if ($api.hasCls('voucher', 'aui-hide')) {
          $api.removeCls('voucher', 'aui-hide');
        }
        if (!$api.hasCls('empty-wrap', 'aui-hide')) {
          $api.addCls('empty-wrap', 'aui-hide');
        }
        $api.text('count', content.count);
        $api.text('date', content.date);
        $api.text('time', content.time);
        $api.attr('voucher-message', 'data-id', content.id);
      }
      else {
        if (!$api.hasCls('voucher', 'aui-hide')) {
          $api.addCls('voucher', 'aui-hide');
        }
        if ($api.hasCls('empty-wrap', 'aui-hide')) {
          $api.removeCls('empty-wrap', 'aui-hide');
        }
      }
    }

    function formatData (data) {
      var content = null;
      if (data.id) {
        content = {
          status: true,
          id: data.id,
          count: data.money,
          date: data.datetime.split(' ')[0],
          time: 7
        }
      }
      else {
        content = {
          status: false
        }
      }
      return content;
    }

    function gotoHome () {
      closeFormwork();
      api.sendEvent({
        name: 'ShowIndex',
        extra: {
          goal: 'home'
        }
      });
    }

    function jump (page) {
      if (checkNetwork() && checkLogin()) {
        var id = $api.attr('voucher-message', 'data-id');
        openFormwork({
          goal: page,
          id: id
        });
      }
    }

    function setListener () {
      api.addEventListener(
        {name:'online'},
        function(ret, err){
          if (ret) init();
        }
      );
    }

    function pullRefresh () {
      var auiPullRefresh = new auiPullToRefresh(
        {
          container: $api.byId('voucher'),
          triggerDistance: 100
        },
        function(ret){
          var htmlStr = '<img src="../../image/loading_more.gif" class="gif" id="zhuanjuhua"/>';
          $api.before('voucher', htmlStr);
          if(ret.status=="success"){
            setTimeout(function(){
              init();
              auiPullRefresh.cancelLoading(); //刷新成功后调用此方法隐藏
              $api.remove('zhuanjuhua');
            },1500)
          }
        }
      );
    }
  </script>
</body>

</html>
