<!DOCTYPE html>
<!-- 借款记录 -->
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, initial-scale=1.0, width=device-width" />
	<meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
	<script type="text/javascript" charset="utf-8" src="../../script/flexible.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/api.js"></script>
	<title>借款记录</title>
	<link rel="stylesheet" type="text/css" href="../../css/aui.css">
  <link rel="stylesheet" type="text/css" href="../../css/aui-extends.css">
	<link rel="stylesheet" type="text/css" href="../../iconfont/iconfont.css">
  <script type="text/javascript" charset="utf-8" src="../../iconfont/iconfont.js"></script>
</head>

<body class="jiekuanjilu">
	<section class="aui-content aui-hide" id="content-wrap">
		<div class="aui-tab tab-wrap" id="tab">
			<div class="aui-tab-item font-size-30 aui-active">全部</div>
			<div class="aui-tab-item font-size-30">待还款</div>
			<div class="aui-tab-item font-size-30">已还款</div>
			<div class="aui-tab-item font-size-30">已逾期</div>
		</div>
		<ul class="receipt-list" id="receipt-list"></ul>
	</section>
	<section class="cover" id="empty-wrap">
		<img class="image-note" src="../../image/empty-loan.png">
		<p class="font-size-30 aui-text-center text-gray margin-top-30">你还没有借款记录哦~</p>
		<button class="loan-btn" onclick="javascript: gotoHome();">立即借款</button>
	</section>
	<script type="text/javascript" charset="utf-8" src="../../script/aui-tab.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/aui-pull-refresh.js"></script>
	<script type="text/javascript" charset="utf-8" src="../../script/global-property.js"></script>
	<script type="text/javascript" charset="utf-8" src="../../script/global-method.js"></script>
	<script type="text/javascript">
		var page = {
			previous: 1,
			current: 1
		};
		var loanMsgArr = null;
		apiready = function () {
      setListener();
			init();
      setTabs();
      pullRefresh();
		}

		function setTabs () {
			var tab = new auiTab(
        {
					element: $api.byId('tab'),
					index: 1,
					repeatClick: false
				},
				function (ret) {
					switch (ret.index) {
						case 1:
              try {
                setLayout('whole');
              } catch (e) {}
							break;
						case 2:
              try {
                setLayout('orange');
              } catch (e) {}
							break;
						case 3:
              try {
                setLayout('green');
              } catch (e) {}
							break;
						case 4:
              try {
                setLayout('red');
              } catch (e) {}
							break;
					}
				}
			);
		}

		function init () {
			if (checkNetwork() && checkLogin()) {
				sendRequest({
					url: 'GetLoanList',
					values: {
						deviceId: api.deviceId,
						phone: User.Phone
					},
					showMessage: true,
					success: function(data) {
            data = formatData(data);
						loanMsgArr = data;
						if (data.length > 0) {
							$api.removeCls('content-wrap', 'aui-hide');
							$api.addCls('empty-wrap', 'aui-hide');
						}
						setLayout('whole');
					}
				});
			}
		}

		function setLayout (color) {
			$api.html('receipt-list', '');
			var htmlStr = '';
			for (var i = 0; i < loanMsgArr.length; i++) {
				switch (color) {
					case 'whole':
						htmlStr += setHTML(loanMsgArr[i]);
						break;
					default:
						if (color === loanMsgArr[i].color) htmlStr += setHTML(loanMsgArr[i]);
				}
			}
			$api.html('receipt-list', htmlStr);
		}

		function setHTML (content) {
			var htmlStr = '<li class="receipt-item padding-left-30 margin-top-21 background-write" data-id="' + content.id + '" onclick="showDetail(this)">' +
          '<div class="receipt-content padding-right-30">' +
            '<div class="aui-pull-left">' +
              '<svg class="icon icon-control icon-size-jiekuanjine" aria-hidden="true">' +
                '<use xlink:href="#icon-jiekuanjine"></use>' +
              '</svg>' +
              '<span class="text-gray font-size-24 padding-left-12">金额(元)</span>' +
            '</div>' +
            '<div class="aui-pull-right text-black font-size-27">' +
              '<span class="text-' + content.color + '">' + content.type + '</span>' +
              '<i class="iconfont icon-youjiantou text-gray font-size-36"></i>' +
            '</div>' +
          '</div>' +
          '<div class="split-line"></div>' +
          '<div class="receipt-content padding-right-30">' +
            '<p class="aui-pull-left text-black">' +
              '<span>借款</span>' +
              '<span>' + content.money + '</span>' +
              '<span>元</span>' +
            '</p>' +
            '<p class="aui-pull-right text-gray font-size-27 aui-text-right">' + content.datetime + '</p>' +
          '</div>' +
        '</li>';
			return htmlStr;
		}

    function gotoHome () {
      closeFormwork();
      api.sendEvent({
        name: 'ShowIndex',
        extra: {
          goal: 'home'
        }
      });
    }

    function showDetail (dom) {
      if (checkNetwork() && checkLogin()) {
        var id = $api.attr(dom, 'data-id');
        openFormwork({
          goal: 'jietiaoxiangdan',
          id: id
        });
      }
    }

    function formatData (data) {
      for (var i = 0; i < data.length; i++) {
        var loan = data[i];
        if (loan.type === '已放款') {
          data[i].type = '待还款';
        }
        data[i].color = LoanStatus[loan.type].color;
      }
      return data;
    }

    function setListener () {
      api.addEventListener(
        {name:'online'},
        function(ret, err){
          if (ret){
            init();
            setTabs();
          }
        }
      );
    }

    function pullRefresh () {
      var auiPullRefresh = new auiPullToRefresh(
        {
          container: $api.byId('content-wrap'),
          triggerDistance: 100
        },
        function(ret){
          var htmlStr = '<img src="../../image/loading_more.gif" class="gif" id="zhuanjuhua"/>';
          $api.before('content-wrap', htmlStr);
          if(ret.status=="success"){
            setTimeout(function(){
              init();
              setTabs();
              auiPullRefresh.cancelLoading(); //刷新成功后调用此方法隐藏
              $api.remove('zhuanjuhua');
            },1500)
          }
        }
      );
    }
	</script>
</body>

</html>
