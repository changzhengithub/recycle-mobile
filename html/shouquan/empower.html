<!DOCTYPE html>
<!-- 授权 -->
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, initial-scale=1.0, width=device-width"
  />
  <meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
  <script type="text/javascript" charset="utf-8" src="../../script/flexible.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/api.js"></script>
  <title>授权</title>
  <link rel="stylesheet" type="text/css" href="../../css/aui.css">
  <link rel="stylesheet" type="text/css" href="../../css/aui-extends.css">
  <link rel="stylesheet" type="text/css" href="../../iconfont/iconfont.css">
</head>

<body class="empower background-write">
  <header class="header-wrap background-transparent">
    <div class="absolute left-addon font-size-30" onclick="javascript: closeFormwork();">
      <i class="iconfont icon-close font-size-45"></i>
    </div>
    <div class="header-tab">
      <button class="header-tab-item selected" onclick="javascript: switchEmpower('login');" id="other-btn">登录</button>
      <button class="header-tab-item" onclick="javascript: switchEmpower('register');" id="register-btn">注册</button>
    </div>
    <img class="header-logo" src="../../image/logo.png">
    <div class="bg absolute">
      <img class="bg-image" src="../../image/empower-bg.png">
    </div>
  </header>
  <section class="aui-content">
    <ul class="aui-list" id="input-list">
      <li class="aui-list-item aui-row" id="phone-input">
        <div class="aui-col-xs-12">
          <div class="input-group">
            <i class="iconfont icon-geren input-group-addon font-size-40 aui-pull-left icon-blue"></i>
            <input class="input-control aui-pull-left" id="phone" type="text" maxlength="11" minlength="11" placeholder="请输入手机号">
            <button class="verification-code-btn font-size-30 aui-pull-right text-blue aui-hide" id="validate-btn" onclick="javascript: getVerificationCode('modify');">获取验证码</button>
          </div>
        </div>
      </li>
      <li class="aui-list-item aui-row aui-hide" id="verification-input">
        <div class="aui-col-xs-12">
          <div class="input-group">
            <i class="iconfont icon-yanzhengma input-group-addon font-size-40 aui-pull-left icon-blue"></i>
            <input class="input-control aui-pull-left" id="validate-code" type="text" maxlength="6" minlength="6" placeholder="请输入验证码">
          </div>
        </div>
      </li>
      <li class="aui-list-item aui-row">
        <div class="aui-col-xs-12">
          <div class="input-group">
            <i class="iconfont icon-suo input-group-addon font-size-40 aui-pull-left icon-blue"></i>
            <input class="input-control aui-pull-left" id="password" type="password" maxlength="16" minlength="6" placeholder="请输入6-16位密码">
            <button class="verification-code-btn font-size-30 aui-pull-right text-blue" id="modify-btn" onclick="javascript: switchEmpower('modify');">忘记密码</button>
          </div>
        </div>
      </li>
    </ul>
  </section>
  <button class="aui-btn btn-fillet font-size-40 aui-text-center margin-top-70" id="submit-btn" onclick="javascript: submit();">登陆</button>
  <section class="note aui-hide" id="note">
    <i class="iconfont icon-agree selected" id="icon-agree" onclick="javascript: acceptProtocol();"></i>
    <span>我已经同意</span>
    <span class="text-blue" onclick="javascript: openProtocols('zhucexieyi');">《花花无忧借款服务与隐私协议》</span>
  </section>
  <script type="text/javascript" charset="utf-8" src="../../script/global/api.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/component/base.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/component/router.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/component/check.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/component/roll.js"></script>
  <script type="text/javascript" charset="utf-8">
    var currentEmpower = 'login';
    var User = null;
    var roll = null;

    apiready = function () {
      roll = new Roll({
        start: function () {
          closeBtnClick('register-btn');
          closeBtnClick('modify-btn');
          closeBtnClick('other-btn');
        },
        rollUpFinish: function () {
          roll.setHeight(currentEmpower);
          setLayout(currentEmpower);
        },
        finish: function () {
          openBtnClick('register-btn');
          openBtnClick('modify-btn');
          openBtnClick('other-btn');
        }
      });
    }

    function switchEmpower(type) {
      if (currentEmpower !== type) {
        currentEmpower = type;
        roll.animation();
      }
    }

    function setLayout(type) {
      var text = null;
      switch (type) {
        case 'login':
          text = '登陆';
          if ($api.hasCls('register-btn', 'selected')) {
            $api.removeCls('register-btn', 'selected');
            $api.addCls('other-btn', 'selected');
          }
          if ($api.hasCls('modify-btn', 'aui-hide')) {
            $api.removeCls('modify-btn', 'aui-hide');
          }
          $api.addCls('verification-input', 'aui-hide');
          $api.text('modify-btn', '忘记密码');
          $api.attr('modify-btn', 'onclick', 'javascript: switchEmpower("modify");');
          $api.attr('other-btn', 'onclick', 'javascript: switchEmpower("login");');
          if (!$api.hasCls('validate-btn', 'aui-hide')) {
            $api.addCls('validate-btn', 'aui-hide');
          }
          if (!$api.hasCls('note', 'aui-hide')) {
            $api.addCls('note', 'aui-hide');
          }
          $api.text('other-btn', text);
          break;
        case 'register':
          text = '注册';
          if ($api.hasCls('other-btn', 'selected')) {
            $api.removeCls('other-btn', 'selected');
            $api.removeCls('verification-input', 'aui-hide');
            $api.addCls('register-btn', 'selected');
          }
          if (!$api.hasCls('modify-btn', 'aui-hide')) $api.addCls('modify-btn', 'aui-hide');
          if ($api.hasCls('validate-btn', 'aui-hide')) $api.removeCls('validate-btn', 'aui-hide');
          if ($api.hasCls('note', 'aui-hide')) $api.removeCls('note', 'aui-hide');
          break;
        case 'modify':
          text = '确认修改';
          if ($api.hasCls('register-btn', 'selected')) {
            $api.removeCls('register-btn', 'selected');
            $api.addCls('other-btn', 'selected');
          }
          if ($api.hasCls('modify-btn', 'aui-hide')) $api.removeCls('modify-btn', 'aui-hide');
          if ($api.hasCls('validate-btn', 'aui-hide')) $api.removeCls('validate-btn', 'aui-hide');
          if (!$api.hasCls('note', 'aui-hide')) $api.addCls('note', 'aui-hide');
          $api.removeCls('verification-input', 'aui-hide');
          $api.text('modify-btn', '返回登陆');
          $api.attr('modify-btn', 'onclick', 'javascript: switchEmpower("login");');
          $api.attr('other-btn', 'onclick', 'javascript: switchEmpower("modify");');
          $api.text('other-btn', '忘记密码');
          break;
      }
      $api.text('submit-btn', text);
    }

    function submit() {
      if (currentEmpower === 'register') {
        if (!$api.hasCls('icon-agree', 'selected')) {
          toast('您尚未接受注册协议');
          return;
        }
      }
      var phone = $api.val('phone'); //帐号
      var password = $api.val('password'); //密码
      var validateCode = $api.val('validate-code');
      var deviceId = api.deviceId; //设备唯一ID
      var deviceModel = api.deviceModel; //设备型号
      var deviceName = api.deviceName; //设备名称
      var operator = api.operator; //运营商
      var connectionType = api.connectionType; //网络链接类型
      var url = null;
      var data = null;
      var values = null;
      var success = null;
      switch (currentEmpower) {
        case 'login':
          url = 'UserLogin';
          data = {
            page: 'login',
            phone: phone,
            password: password
          };
          values = {
            phone: phone,
            password: password,
            deviceId: deviceId,
            deviceModel: deviceModel,
            deviceName: deviceName,
            operator: operator,
            connectionType: connectionType
          };
          success = function (data) {
            User = $api.getStorage('User');
            data = formatData(data);
            User = {
              Status: true,
              Phone: phone,
              Step: data.step,
              Archive: {
                Name: data.name,
                Id: data.id
              },
              Card: data.card
            };
            $api.setStorage('User', User);
            setLoginStatus();
            closeFormwork('empower');
          };
          break;
        case 'register':
          url = 'UserRegister';
          data = {
            page: 'register',
            phone: phone,
            password: password,
            validateCode: validateCode
          };
          values = {
            deviceId: deviceId,
            phone: phone,
            password: password,
            validateCode: validateCode
          };
          success = function () {
            User = $api.getStorage('User');
            User = {
              Status: true,
              Phone: phone,
              Step: 0
            };
            Loan = {
              time: null,
              rate: null,
              capital: null,
              dividend: null
            };
            $api.setStorage('User', User);
            $api.setStorage('Loan', Loan);
            setLoginStatus();
            create('empower');
          }
          break;
        case 'modify':
          url = 'FindPass';
          data = {
            page: 'modify',
            phone: phone,
            password: password,
            validateCode: validateCode
          };
          values = {
            phone: phone,
            validateCode: validateCode,
            password: password
          }
          success = function () {
            User = {
              Status: false,
              Phone: phone,
              Step: 0
            };
            Loan = {
              time: null,
              rate: null,
              capital: null,
              dividend: null
            };
            $api.setStorage('User', User);
            $api.setStorage('Loan', Loan);
            toast('请您再次登陆');
            switchEmpower("login");
          }
          break;
      }
      if (checkNetwork() && checkFormat({
          data: data
        })) {
        closeBtnClick('submit-btn');
        sendRequest({
          url: url,
          values: values,
          showMessage: true,
          success: function (data) {
            try {
              success(data);
            } catch (e) {}
          },
          default: function () {
            openBtnClick('submit-btn');
          }
        });
      }
    }

    function getVerificationCode() {
      closeBtnClick('validate-btn');
      checkNetwork({
        success: function () {
          checkFormat({
            data: {
              phone: $api.val('phone')
            },
            success: function () {
              var type = null;
              switch (currentEmpower) {
                case 'register':
                  type = '1';
                  break;
                case 'modify':
                  type = '2';
              }
              sendRequest({
                url: 'SendTemplateSMS',
                values: {
                  phone: $api.val('phone'),
                  type: type
                },
                showMessage: '正在发送...',
                success: function () {
                  readyToResend();
                },
                default: function () {
                  openBtnClick('validate-btn');
                }
              });
            },
            fail: function () {
              openBtnClick('validate-btn');
            }
          });
        },
        fail: function () {
          openBtnClick('validate-btn');
        }
      });

      /**
       * [readyToResend 等待下一次发送验证码]
       * @method      readyToResend
       * @version     [1.0]
       * @author      [潘剑]
       * @Proofreader [潘剑]
       * @datetime    2017-10-12T14:14:40+080
       */
      function readyToResend() {
        var btnDom = $api.byId('validate-btn');
        $api.attr(btnDom, 'disabled', 'disabled');
        $api.addCls(btnDom, 'ready');
        var second = 60;
        var animation = setInterval(function () {
          if (second > 0) {
            $api.text(btnDom, second + '秒后重试');
            second--;
          } else {
            clearInterval(animation);
            $api.text(btnDom, '获取验证码');
            $api.removeCls(btnDom, 'ready');
            $api.removeAttr(btnDom, 'disabled');
          }
        }, 1000);
      }
    }

    function setLoginStatus() {
      User = $api.getStorage('User');
      api.sendEvent({
        name: 'Login'
      });
    }

    function acceptProtocol() {
      $api.toggleCls('icon-agree', 'selected');
    }

    function openProtocols(page) {
      if (checkNetwork()) {
        openFormwork(page);
      }
    }

    function formatData(data) {
      var content = {
        name: data.XingMing,
        step: data.Step * 1,
        id: data.ShenFenZheng,
        card: []
      };

      for (var i = 0; i < data.CardList.length; i++) {
        var oldCard = data.CardList[i];
        var card = {
          bank: oldCard.KaiHuHang,
          number: oldCard.KaHao,
          type: oldCard.KaiHuHang
        }
        if (card.bank.indexOf('邮政') !== -1) {
          card.bank = '邮政储蓄银行';
        }
        content.card.push(card);
      }

      return content;
    }

    function setLogoutStatus() {
      api.sendEvent({
        name: 'Logout'
      });
    }
  </script>
</body>

</html>