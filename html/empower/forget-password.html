<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, initial-scale=1.0, width=device-width"
  />
  <meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
  <title>忘记密码</title>
  <link rel="stylesheet" type="text/css" href="../../css/empower/forget-password.css">
</head>

</head>

<body>
  <header class="header">
    <img src="../../image/common/back.png" class="back" onclick="javascript: kill();">
    <p class="header-title">找回密码</p>
  </header>
  <div class="content">
    <div class="userphone">
      <p class="hint">你的手机号码为:</p>
      <h4 class="phone" id="account">18655191663</h4>
    </div>
  </div>

  <div class="setpass">
    <ul>
      <li class="setleft">
        <p class="text">图片验证码</p>
        <input id="image-code" type="text" placeholder="请输入图片验证码">
        <img src="http://passport.360.cn/captcha.php?m=create&app=i360&scene=login&userip=&level=default&sign=8820a4&r=1523681447&_=1523681453866">
      </li>
      <li class="setleft-three">
        <p class="text">验证码</p>
        <input id="phone-code" type="text" placeholder="请输入验证码">
        <span class="sendMsg" onclick="javascript: sendSMS();">发送验证码</span>
      </li>
      <li class="setpass-left">
        <p class="text">设置密码</p>
        <input id="password" type="text" placeholder="请设置6-12位数字和字母">
        <img src="../../image/common/switch.png" alt="" class="switch">
        <img src="../../image/common/clear.png" alt="" class="clear">
      </li>
      <li class="setpass-left">
        <p class="text">确认密码</p>
        <input id="repeat-password" type="text" placeholder="请与设置密码保持一致">
        <img src="../../image/common/switch.png" alt="" class="switch">
        <img src="../../image/common/clear.png" alt="" class="clear">
      </li>
    </ul>
  </div>
  <button class="btn" onclick="javascript: submit();">确定</button>
  <script type="text/javascript" charset="utf-8" src="../../script/global/api.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/global/request.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/global/request-status.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/component/router.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/component/base.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/component/check/checkPhone.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/component/check/checkImageVerificationCode.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/component/check/checkPassword.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/component/check/checkPhoneVerificationCode.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/component/other/toggleBtnDisabled.js"></script>
  <script type="text/javascript" charset="utf-8" src="../../script/global/urls.js"></script>
  <script type="text/javascript" charset="utf-8">
    var User = null;

    apiready = function () {
      User = $api.getStorage('User');
      $api.text('account', User.Phone);

      // var user = $api.getStorage('key');

      $api.text('phone', '');
    }

    function sendSMS() {
      if (!checkNet()) return;

      var account = $api.val('account');
      if (!checkPhone(account)) return;

      var imageCode = $api.val('image-code');
      if (checkImageVerificationCode(imageCode)) return;

      request({
        url: 'FindPass',
        values: {
          phone:$api.text('phone'),
          imageCode: imageCode,
          type:'找回密码'
        },
        showMessage: '正在发送...',
        init: function () {
          closeBtnClick('send-image-btn');
        },
        success: function (data) {
              /*   */
        },
        default: function () {
          openBtnClick('send-image-btn');
        }
      });
    }

    function submit() {
      if (!checkNet()) return;

      var account = $api.val('account');
      if (!checkPhone(account)) return;

      var phoneCode = $api.val('phone-code');
      var password = $api.val('password');
      var repeatPassword = $api.val('repeat-password');

      if (!checkPhoneVerificationCode(phoneCode)) return;
      if (!checkPassword(password)) return;
      if (!checkPassword(repeatPassword)) return;
      if (repeatPassword !== password) {
        toast('请确认新密码');
        return;
      }

      request({
        url: 'FindPass',
        values: {
          phone: account,
          yam: phoneCode,
          pass: password
        },
        showMessage: '正在发送...',
        init: function () {
          closeBtnClick('send-image-btn');
          closeBtnClick('submit-btn');
        },
        success: function () {
          setLoginStatus(data);
          sendLoginEvent();
          kill(['login', '']);
        },
        default: function () {
          openBtnClick('send-image-btn');
          openBtnClick('submit-btn');
        }
      });
    }

    function setLoginStatus(data) {
      User = $api.getStorage('User');
      User.Status = true;
      for (const key in data) {
        if (data.hasOwnProperty(key)) User[key] = object[key];
      }
      $api.setStorage('User', User);
    }

    function sendLoginEvent() {
      api.sendEvent({
        name: 'LOGIN-EVENT'
      });
    }
  </script>
</body>

</html>
